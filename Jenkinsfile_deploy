pipeline{
 agent {
    node {
        label 'CI_env'
        customWorkspace '/var/jenkins'
    }
 }
 environment {
   def workspace = pwd()
   // Servers
   localrepo = '/root/.m2/repository/'
//   def http_server = "http://${ip}:8080"
   def image = "artifactory.legsup.co.uk:8082/web_app:${version}"
   registry = 'artifactory.legsup.co.uk:8082'
   pomversion = readMavenPom(file:'app/pom.xml').getVersion()
   pomid = readMavenPom(file:'app/pom.xml').getArtifactId()
 }

 stages{
    stage('checkout SCM'){
        steps {
            checkout scm
        }
    }
    stage ('Deploy to Server'){
      steps{
        script {
          img = docker.image("${image}").withRun { c ->
          def ip = sh returnStdout: true, script: "docker inspect -f {{.NetworkSettings.IPAddress}} ${c.id} | cut -c 1- "
          def url = sh returnStdout: true, script: "echo /var/jenkins/ip.sh ${ip}"
          echo ip
//          sh "sleep 3"
//          def response = httpRequest http_server
//          println("Status: "+response.status)
//          input "Is build is success ?"
          }
        }
      }
    }
//    stage ('Set tag version and push to artifactory'){
//      steps{
//        script {
//          def newtag = sh returnStdout: true, script: 'echo "${version%_*}"'
//          sh "/var/jenkins/tag.sh ${version} v${newtag}"
//        }
//      }
//    }
 }
}